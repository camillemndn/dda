---
title: "ICS"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{ICS}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
  %\VignetteDepends{tidyverse}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(dda)
library(tidyverse)
library(GGally)
```

```{r preprocessing}
data(vietnam_temperature)
selected_years <- 2013:2016

system.time(
  vnt <- vietnam_temperature |>
    filter(year %in% selected_years) |>
    filter(region %in% c("NMM", "RRD") | province %in% c("ANGIANG", "BACLIEU")) |>
    arrange(region, province) |>
    mutate(across(c(t_min, t_max), \(x) as_dd(x, lambda = 1, nbasis = 18, mc.cores = 16)))
)

vnt |> plot_funs(t_max, color = region)
```

```{r ics}
t_max_ics <- ICS(vnt$t_max, center = TRUE)
plot(t_max_ics$gen_kurtosis)

ggpairs(as.data.frame(t_max_ics$scores),
  diag = "blank",
  columns = c(1:3, 8:9),
  aes(label = seq_len(nrow(vnt)), color = vnt$region, shape = NA)
) + geom_text()
```

```{r inprod}
t_max_out <- ICS_outlier(vnt$t_max)
ICS_outlier(as.fd(vnt$t_max), index = 1:4)
```

```{r checks}
x <- ddobj
t_max_ics <- ICS(x)
error <- inprod(c(x), t_max_ics$H) - t_max_ics$scores
max(error)

t_max_ics <- ICS(x, slow = TRUE)
error <- inprod(c(x), t_max_ics$H) - t_max_ics$scores
max(error)

t_max_ics <- ICS(x, center = TRUE)
error <- inprod(c(center(x)), t_max_ics$H) - t_max_ics$scores
max(error)

t_max_ics <- ICS(x, center = TRUE, slow = TRUE)
error <- inprod(c(center(x)), t_max_ics$H) - t_max_ics$scores
max(error)
```

```{r reconstructing}
x <- ddobj
t_max_mean <- c(mean(x))
t_max_ics <- ICS(x, center = TRUE, slow = TRUE)
x <- x[1]
h_dual <- to_zbsplines(t_max_ics$H_dual)
basisobj <- x$basis

t_max_rec <- to_zbsplines(
  inv = TRUE,
  coefs = t(t_max_ics$scores[1, ] %*% t(h_dual)),
  basis = basisobj,
)
t_max_rec <- t_max_rec |> sweep(1, t_max_mean$coefs, "+")
t_max_rec <- dd(clr = fd(coef = t_max_rec, basisobj = basisobj))

plot(c(x) - t_max_rec)
print(paste("True value:", c(x)$coefs))
print(paste("Reconstructed value:", t_max_rec$coefs))
```

```{r gaussian-coefs}
library(mvnfast)

coefs <- rbind(
  rmvn(5, mu = c(10, rep(0, 3)), sigma = diag(4)),
  rmvn(95, mu = rep(0, 4), sigma = diag(4))
)

basisobj <- create.bspline.basis(nbasis = 4)

ddobj <- dd(clr = fd(t(coefs), basisobj))

plot(ICS_outlier(ddobj))
plot(ICS_outlier(as.fd(ddobj, slow = TRUE)))
```


```{r inprod-vs-integrate}
p <- dd(vietnam_temperature$t_max[[2]])

cat("\n")
ival <- p$basis$rangeval

integrate(\(t) eval.fd(p, t), ival[1], ival[2])
inprod(p)

bspint <- inprod(p$basis)
t(bspint) %*% p$coefs
```

