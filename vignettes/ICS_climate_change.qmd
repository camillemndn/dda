---
title: ICS and climate change in Vietnam
vignette: >
  %\VignetteIndexEntry{ICS and climate change in Vietnam}
  %\VignetteEngine{quarto::html}
  %\VignetteEncoding{UTF-8}
lightbox: true
toc: true
fig-width: 15
fig-height: 10
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 15,
  fig.height = 10,
  dev = "pdf",
  fig.ext = "pdf"
)
```

# 10 periods, 26 provinces

We compute an average density per province per period of 3 years.
There are 10 periods total, and only 26 provinces in the two northern
regions of Vietnam, so 260 observations total.

```{r ten_periods}
library(dda)
library(tidyverse)
library(sf)
data(vietnam_temperature)
data(vietnam_regions)

vietnam_temperature <- vietnam_temperature |>
  select(!t_min) |>
  mutate(period = as.factor(1 + (year - min(year)) %/% 3))

vnt <- vietnam_temperature |>
  left_join(vietnam_regions, by = c("region" = "code")) |>
  filter(region %in% c("RRD", "NMM")) |>
  mutate(t_max = as_dd(t_max, lambda = 10, nbasis = 10, mc.cores = 15)) |>
  group_by(region, province, period) |>
  summarise(t_max = list(c(mean(t_max)))) |>
  ungroup() |>
  left_join(vietnam_regions, by = c("region" = "code")) |>
  rename(region_name = name) |>
  arrange(region, province, period)

class(vnt$t_max) <- c("ddl", "fdl", "list")

vnt |> plot_funs(t_max, color = province) +
  facet_wrap(vars(period))
```

```{r outliers}
icsout <- ICS_outlier(as_dd(vnt$t_max), index = 1:4, n_cores = 14)
plot(icsout)
```

```{r interpretation}
vnt <- vnt |> mutate(
  t_max = as_dd(t_max),
  outlying = as.factor(icsout$outliers),
)

vnt |> plot_funs(t_max, color = ifelse(outlying == 1, province, "not outlying"), alpha = outlying) +
  facet_wrap(vars(period))
```

# 30 years, 1 climate region (13 provinces)

```{r climate_regions}
tryCatch(data(vietnam_provinces_north), error = function(e) {
  print(e)
  data(vietnam_provinces)

  vietnam_provinces_north <- vietnam_provinces |>
    filter(region %in% c("RRD", "NMM")) |>
    arrange(region, province) |>
    mutate(climate_region = case_when(
      province %in% c("LAICHAU", "DIENBIEN", "SONLA") ~ "S1",
      province %in% c(
        "LAOCAI", "YENBAI", "HAGIANG", "CAOBANG", "TUYENQUANG",
        "BACKAN", "THAINGUYEN", "LANGSON", "BACGIANG", "QUANGNINH"
      ) ~ "S2",
      .default = "S3"
    ))
})

vietnam_provinces_north |>
  ggplot(aes(fill = climate_region, label = province)) +
  geom_sf() +
  geom_sf_label(fill = "white")
```

```{r ics_climate_regions}
library(tidyverse)
library(sf)
data(vietnam_temperature)
data(vietnam_regions)
data(vietnam_provinces_north)

vnt <- vietnam_temperature |>
  filter(region %in% c("RRD", "NMM")) |>
  dplyr::select(year, province, t_max) |>
  left_join(vietnam_provinces_north, by = "province") |>
  st_as_sf() |>
  dplyr::select(year, climate_region, province, t_max) |>
  filter(climate_region == "S3") |>
  arrange(year, province)

vnt <- vnt |>
  mutate(t_max = as_dd(t_max, lambda = 10, nbasis = 10, mc.cores = 15))
class(vnt$t_max) <- c("ddl", "fdl", "list")

vnt |> plot_funs(t_max, color = province) +
  facet_wrap(vars(year))
```

```{r climate_regions_outliers}
icsout <- ICS_outlier(as_dd(vnt$t_max), index = 1:2, n_cores = 14)
plot(icsout)

vnt <- vnt |> mutate(
  t_max = as_dd(t_max),
  outlying = as.factor(icsout$outliers),
)
vnt |> plot_funs(t_max, color = ifelse(outlying == 1, province, "not outlying"), alpha = outlying) +
  facet_wrap(vars(year))

as_tibble(cbind(icsout$scores, vnt)) |>
  mutate(province = if_else(outlying == 1, province, "not outlying")) |>
  GGally::ggpairs(
    diag = "blank",
    upper = "blank",
    legend = 3,
    columns = 1:max(max(icsout$index), 2),
    aes(label = year, shape = NA, color = province, alpha = outlying)
  ) + geom_text()
```

If we force to 0 the first and last ZB-spline coordinates of the $\operatorname{clr}$,
we project them onto the space of splines contrained to $0$ on the
boundaries of the interval.

```{r zero_boundary}
boundary_to_zero <- function(x) {
  b <- x$basis
  p <- b$nbasis
  zbsp <- fd(to_zbsplines(inv = TRUE, coefs = diag(p - 1), basis = b), b)
  plot(zbsp)

  y <- to_zbsplines(x)
  y[c(1, p - 1), ] <- 0
  yfd <- fd(to_zbsplines(inv = TRUE, coefs = y, basis = b), b)

  list(dd = yfd, coefs = t(y[2:(p - 2), ]))
}
icsout <- ICS_outlier(boundary_to_zero(c(vnt$t_max))$coefs)

vnt |>
  mutate(
    t_max = as.list(as.fd(boundary_to_zero(c(t_max))$dd)),
    outlying = as.factor(icsout$outliers)
  ) |>
  plot_funs(t_max, color = outlying) +
  facet_wrap(vars(year))
```

